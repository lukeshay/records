name: CD

on:
  workflow_dispatch:
  push:
    branches:
      - "main"

concurrency: ${{ github.workflow }}-${{ github.ref }}

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - run: |
          mkdir tmp
          cd tmp
          curl -fsSL https://github.com/lukeshay/deployer/releases/download/v0.0.3/deployer-linux-x86_64.tar.gz --output deployer.tar.gz
          tar -xzvf deployer.tar.gz
      - name: Dagger
        uses: dagger/dagger-for-github@v5
        env:
          DEPLOYER_DOCKER_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
        with:
          verb: run
          args: ./tmp/deployer dagger docker build --username ${{ github.actor }} --repository ghcr.io/lukeshay/deployer --tags "main,latest,$GITHUB_SHA" --labels "org.opencontainers.image.revision=$GITHUB_SHA" --publish
  deploy:
    needs:
      - build
    runs-on: ubuntu-22.04
    environment:
      name: prod
      url: https://ls-records.fly.dev/
    steps:
      - uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/checkout@v4
      - run: docker pull ghcr.io/lukeshay/deployer:$GITHUB_SHA
      - uses: superfly/flyctl-actions/setup-flyctl@master
      - run: flyctl deploy --image ghcr.io/lukeshay/deployer:$GITHUB_SHA
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
